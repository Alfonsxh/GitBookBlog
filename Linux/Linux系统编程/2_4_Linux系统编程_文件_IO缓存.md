# Linux系统编程:文件_IO缓存

## I/O缓存概览

![I/O_cache](/Image/Linux/Chapter13/13_io_cache.png)

Linux系统中的 **文件I/O缓存** 操作大致如上图所示：

- **用户态空间**
  - 一般情况下，我们是通过 **stdio库函数** 来操作文件，包括 **printf()、scanf()、fopen()等**。**在调用stdio库函数** 时，默认会先存放在用户态空间申请的 **stdio缓存区中**。
  - 不过，但如果使用 **setvbuf()、setbuf()、setbuffer()** 函数使 **stdio缓存区无效** 时，**stdio库函数** 在执行时会立即调用 **I/O系统调用**。
  - 另外，如果使用了 **fflush()**，那么立刻刷新 **stdio缓存区**，执行 **I/O系统调用**。
- **内核态空间**
  - 在内核态空间，默认会有 **内核高速缓存区** 用来存储需要 **写入磁盘的内容**。
  - **在使用I/O系统调用** 时，如果指定了 **open()函数** 的打开方式为 **O_SYNC模式**，那么 **I/O系统调用** 处理的内容不会经过 **内核高速缓存区**，而是直接由内核发起写操作，将内容写入磁盘。
  - 和stdio库函数操作缓存区类似，也有刷新 **内核高速缓存区** 的系统调用：**fsync()、fdatasync()、sync()**。
  - 另外，会有 **内核线程定时刷新内核高速缓存区**。
- **磁盘空间**
  - 现在大多数 **磁盘驱动** 也会创建自己的 **磁盘驱动缓存区**。
  - 由内核发起的写操作，会先缓存在磁盘驱动缓存区中，然后再写入磁盘。

Linux系统的文件I/O缓存大致就分为以上三个缓存区：**stdio缓存区**、**内核高速缓存区**、**磁盘驱动缓存区**。